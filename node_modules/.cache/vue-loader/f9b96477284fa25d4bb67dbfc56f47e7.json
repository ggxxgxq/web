{"remainingRequest":"/Users/gaoxiangqing/Documents/gaoxiangqing/smilcool/smilcool-client/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/gaoxiangqing/Documents/gaoxiangqing/smilcool/smilcool-client/src/views/message/Message.vue?vue&type=style&index=0&id=8d2d3196&lang=less&scoped=true","dependencies":[{"path":"/Users/gaoxiangqing/Documents/gaoxiangqing/smilcool/smilcool-client/src/views/message/Message.vue","mtime":1712587400027},{"path":"/Users/gaoxiangqing/Documents/gaoxiangqing/smilcool/smilcool-client/node_modules/css-loader/index.js","mtime":1712590522695},{"path":"/Users/gaoxiangqing/Documents/gaoxiangqing/smilcool/smilcool-client/node_modules/vue-loader/lib/loaders/stylePostLoader.js","mtime":1712590523760},{"path":"/Users/gaoxiangqing/Documents/gaoxiangqing/smilcool/smilcool-client/node_modules/postcss-loader/src/index.js","mtime":1712590523260},{"path":"/Users/gaoxiangqing/Documents/gaoxiangqing/smilcool/smilcool-client/node_modules/less-loader/dist/cjs.js","mtime":1712590524064},{"path":"/Users/gaoxiangqing/Documents/gaoxiangqing/smilcool/smilcool-client/node_modules/cache-loader/dist/cjs.js","mtime":1712590523146},{"path":"/Users/gaoxiangqing/Documents/gaoxiangqing/smilcool/smilcool-client/node_modules/vue-loader/lib/index.js","mtime":1712590523434}],"contextDependencies":[],"result":["\n.container {\n  width: 1140px;\n  margin: 40px auto 0;\n  padding: 5px;\n\n  .ivu-col {\n    padding: 5px;\n  }\n\n  .card {\n    height: 720px;\n  }\n\n  .friend-list-container {\n    height: 625px;\n    overflow: auto;\n\n    .items {\n      .item {\n        cursor: pointer;\n        margin-bottom: 5px;\n        padding: 2px;\n        border-radius: 30px;\n\n        .image {\n          width: 60px;\n          height: 60px;\n        }\n\n        .meta {\n          white-space: nowrap;\n          overflow: hidden;\n          text-overflow: ellipsis;\n        }\n      }\n\n      .item:hover,\n      .item.active {\n        background: #eeeeee;\n      }\n    }\n  }\n\n  .message-list-container {\n    .current-friend {\n      height: 20px;\n      padding: 0 10px;\n\n      p {\n        position: relative;\n        top: -5px;\n        color: #666;\n      }\n    }\n\n    .message-list {\n      height: 480px;\n      margin-bottom: 15px;\n      padding: 10px;\n      overflow: auto;\n\n      .time {\n        text-align: center;\n        font-size: 12px;\n        color: #666666;\n        margin-bottom: 10px;\n      }\n\n      .bubble-wrapper {\n        clear: right;\n        margin-bottom: 20px;\n        overflow: auto;\n\n        .bubble {\n          display: inline-block;\n          max-width: 65%;\n          padding: 9px 14px;\n          border-radius: 20px;\n          font-size: 14px;\n          line-height: 24px;\n        }\n\n        .left-bubble {\n          float: left;\n          background: #fdfdfd;\n          border: 1px solid rgba(0, 0, 0, 0.05);\n          border-top-left-radius: 0;\n        }\n\n        .right-bubble {\n          float: right;\n          color: #fff;\n          background-color: #3FD1E1;\n          border-bottom-right-radius: 0;\n        }\n      }\n    }\n\n    .message-input {\n      textarea {\n        resize: none;\n        height: 100%;\n      }\n    }\n  }\n}\n",{"version":3,"sources":["Message.vue"],"names":[],"mappings":";AA4OA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"Message.vue","sourceRoot":"src/views/message","sourcesContent":["<template>\n  <div class=\"container\">\n    <Row>\n      <iCol>\n        <sui-card class=\"fluid\">\n          <sui-message attached=\"top\">æ¶ˆæ¯ä¸­å¿ƒ</sui-message>\n          <sui-card-content>\n            <Row>\n              <iCol span=\"7\">\n                <!-- å¥½å‹åˆ—è¡¨ -->\n                <div class=\"friend-list-container\">\n                  <sui-item-group v-if=\"friendList.length > 0\">\n                    <!-- å¥½å‹åˆ—è¡¨ -->\n                    <sui-item v-for=\"friend in friendList\"\n                              :key=\"friend.id\"\n                              :class=\"{active: currentFriend === friend}\"\n                              @click.native=\"selectFriend(friend)\">\n                      <sui-image circular :src=\"friend.avatar\"/>\n                      <sui-item-content>\n                        <sui-item-description>{{friend.nickname}}\n                          <Badge :count=\"friend.unread\"/>\n                        </sui-item-description>\n                        <!-- æ˜¾ç¤ºå½“å‰å¥½å‹æœ€æ–°ä¿¡æ¯ -->\n                        <sui-item-meta>{{lastMessage(friend)}}</sui-item-meta>\n                      </sui-item-content>\n                    </sui-item>\n                  </sui-item-group>\n                  <span v-else>æš‚æ— å¥½å‹</span>\n                </div>\n                <!-- å¥½å‹åˆ—è¡¨ END -->\n              </iCol>\n              <iCol span=\"17\">\n                <!-- èŠå¤©æ¡† -->\n                <div v-if=\"currentFriend\" class=\"message-list-container\">\n                  <!-- èŠå¤©ç”¨æˆ· -->\n                  <div class=\"current-friend\">\n                    <p>å’Œ {{currentFriend.nickname}} èŠå¤©ä¸­...</p>\n                  </div>\n                  <!-- èŠå¤©ç”¨æˆ· END -->\n                  <!-- æ¶ˆæ¯åˆ—è¡¨ -->\n                  <div ref=\"messageList\" class=\"message-list\">\n                    <!--<div class=\"time\">7åˆ†é’Ÿå‰</div>-->\n                    <template v-for=\"message in currentMessageList\">\n                      <!-- å‘é€çš„æ¶ˆæ¯ -->\n                      <div class=\"bubble-wrapper\" v-if=\"message.sendUserId === user.id\">\n                        <div class=\"bubble right-bubble\" v-html=\"message.content\"/>\n                      </div>\n                      <!-- æ¥æ”¶çš„æ¶ˆæ¯ -->\n                      <div class=\"bubble-wrapper\" v-if=\"message.receiveUserId === user.id\">\n                        <div class=\"bubble left-bubble\" v-html=\"message.content\"/>\n                      </div>\n                    </template>\n                  </div>\n                  <!-- æ¶ˆæ¯åˆ—è¡¨ END -->\n                  <!-- è¾“å…¥æ¡† -->\n                  <sui-form class=\"message-input\">\n                    <sui-form-field>\n                      <textarea placeholder=\"è¾“å…¥æ¶ˆæ¯\" v-model=\"message\" rows=\"3\" @keydown.ctrl.enter=\"chat\"/>\n                    </sui-form-field>\n                    <sui-form-field>\n                      <sui-button basic floated=\"right\" content=\"å‘é€(Ctrl+Enter)\" @click.prevent=\"chat\"/>\n                    </sui-form-field>\n                  </sui-form>\n                  <!-- è¾“å…¥æ¡† END -->\n                </div>\n                <!-- æç¤ºæ¡† -->\n                <div v-else>\n                  <sui-message>\n                    <sui-message-header>\n                      <sui-icon name=\"bell outline\"/>\n                      è¿™é‡Œæ˜¯æ¶ˆæ¯ä¸­å¿ƒ\n                    </sui-message-header>\n                    <p>åœ¨è¿™é‡Œï¼Œä½ å¯ä»¥æ¥æ”¶åˆ°ç³»ç»Ÿå‘é€çš„æ¶ˆæ¯ã€‚ä½ ä¹Ÿå¯ä»¥å‘é€æ¶ˆæ¯è”ç³»ä½ çš„å¥½å‹æˆ–æ˜¯æ ¡å‹ï¼Œå¿«æ¥å¼€å¯æ„‰å¿«çš„èŠå¤©ä¹‹æ—…å§ ğŸ¤—</p>\n                  </sui-message>\n                </div>\n                <!-- æç¤ºæ¡† END -->\n                <!-- èŠå¤©æ¡† END -->\n              </iCol>\n            </Row>\n          </sui-card-content>\n        </sui-card>\n      </iCol>\n    </Row>\n  </div>\n</template>\n\n<script>\nimport storage from '@/utils/storage'\n\nexport default {\n  name: 'Message',\n  data() {\n    return {\n      message: '',\n      user: this.$store.state.user,\n      currentFriend: null,\n      currentMessageList: [],\n      webSocket: null,\n      friendList: [],\n      // æ¶ˆæ¯ç±»å‹\n      messageType: {\n        CONNECT: 0,\n        CHAT: 1,\n        SIGNED: 2,\n        KEEP_ALIVE: 3\n      }\n    }\n  },\n  methods: {\n    // åˆ‡æ¢å¥½å‹\n    selectFriend(friend) {\n      this.currentFriend = friend;\n      this.currentMessageList = friend.messageList;\n      this.currentFriend.unread = 0;\n    },\n    // è·å–å¥½å‹\n    getFriendList() {\n      this.$axios.get('/api/friend')\n        .then(res => {\n          let result = res.data;\n          // è·å–å¥½å‹\n          this.friendList = result.data;\n          // è·å–å†å²æ¶ˆæ¯\n          this.friendList.forEach(friend => {\n            friend.unread = 0;\n            friend.messageList = this.getMessageList(friend.id);\n          });\n          // å»ºç«‹è¿æ¥\n          this.connectWebSocketServer();\n        });\n    },\n    // è·å–æ¶ˆæ¯åˆ—è¡¨\n    getMessageList(friendId) {\n      let messageList = storage.get(`${this.user.id}-${friendId}`);\n      return messageList != null ? messageList : [];\n    },\n    // å­˜å‚¨æ¶ˆæ¯åˆ—è¡¨\n    saveMessageList(friendId, message) {\n      let messageList = this.getMessageList(friendId);\n      messageList.push(message);\n      storage.set(`${this.user.id}-${friendId}`, messageList);\n    },\n    // è¿æ¥ WebSocket æœåŠ¡å™¨\n    connectWebSocketServer() {\n      // è·å– WebSocket Server URL\n      this.$axios.get('/api/sys/ws')\n        .then(res => this.initWebSocket(res.data));\n    },\n    // åˆå§‹åŒ– WebSocket å¹¶è¿æ¥\n    initWebSocket(url) {\n      this.webSocket = new WebSocket(url);\n      // å»ºç«‹è¿æ¥\n      this.webSocket.onopen = event => {\n        console.log('ws.onopen: ', event);\n        this.connect();\n        setInterval(this.keepAlive, 30 * 1000);\n      };\n      // æ¥æ”¶æ¶ˆæ¯\n      this.webSocket.onmessage = event => {\n        console.log('ws.onmessage: ', event);\n        let message = JSON.parse(event.data);\n        // æ ¹æ® sendUserId å’Œ receiveUserIdï¼Œå°†æ¶ˆæ¯æ”¾å…¥å¯¹åº” friend ä¸‹çš„ messageList ä¸­\n        this.friendList.forEach(friend => {\n          if (message.sendUserId === friend.id || message.receiveUserId === friend.id) {\n            friend.messageList.push(message);\n            // ä¿å­˜æ¶ˆæ¯\n            this.saveMessageList(friend.id, message);\n            if (friend !== this.currentFriend) {\n              this.$set(friend, 'unread', friend.unread + 1);\n            }\n          }\n        });\n        // ç­¾æ”¶æ¶ˆæ¯\n        this.signed(message.id);\n      };\n      // å…³é—­è¿æ¥\n      this.webSocket.onclose = event => console.log('ws.onclose: ', event);\n      // å‘ç”Ÿå¼‚å¸¸\n      this.webSocket.onerror = event => console.log('ws.onerror: ', event);\n    },\n    // è¿æ¥\n    connect() {\n      let connectMessage = { type: this.messageType.CONNECT, sendUserId: this.user.id };\n      this.send(connectMessage);\n    },\n    // å¿ƒè·³åŒ…\n    keepAlive() {\n      let keepAliveMessage = { type: this.messageType.KEEP_ALIVE };\n      this.send(keepAliveMessage);\n    },\n    // èŠå¤©æ¶ˆæ¯\n    chat() {\n      let chatMessage = {\n        type: this.messageType.CHAT,\n        sendUserId: this.user.id,\n        receiveUserId: this.currentFriend.id,\n        content: this.message\n      };\n      this.currentMessageList.push(chatMessage);\n      this.send(chatMessage);\n      this.saveMessageList(this.currentFriend.id, chatMessage);\n      this.message = '';\n    },\n    // ç­¾æ”¶æ¶ˆæ¯\n    signed(id) {\n      let signedMessage = { type: this.messageType.SIGNED, content: id };\n      this.send(signedMessage);\n    },\n    // å‘é€æ¶ˆæ¯\n    send(message) {\n      console.log('send: ', JSON.stringify(message));\n      this.webSocket.send(JSON.stringify(message));\n    },\n    // è·å–æœ€åä¸€æ¡æ¶ˆæ¯\n    lastMessage(friend) {\n      let len = friend.messageList.length;\n      return len > 0 ? friend.messageList[len - 1].content : 'æš‚æ— æ¶ˆæ¯';\n    }\n  },\n  watch: {\n    currentMessageList() {\n      this.$nextTick(() => {\n        let messageList = this.$refs.messageList;\n        messageList.scrollTop = messageList.scrollHeight;\n      })\n    }\n  },\n  mounted() {\n    // è·å–å¥½å‹åˆ—è¡¨\n    this.getFriendList();\n  }\n}\n\n</script>\n\n<style lang=\"less\" scoped>\n.container {\n  width: 1140px;\n  margin: 40px auto 0;\n  padding: 5px;\n\n  .ivu-col {\n    padding: 5px;\n  }\n\n  .card {\n    height: 720px;\n  }\n\n  .friend-list-container {\n    height: 625px;\n    overflow: auto;\n\n    .items {\n      .item {\n        cursor: pointer;\n        margin-bottom: 5px;\n        padding: 2px;\n        border-radius: 30px;\n\n        .image {\n          width: 60px;\n          height: 60px;\n        }\n\n        .meta {\n          white-space: nowrap;\n          overflow: hidden;\n          text-overflow: ellipsis;\n        }\n      }\n\n      .item:hover,\n      .item.active {\n        background: #eeeeee;\n      }\n    }\n  }\n\n  .message-list-container {\n    .current-friend {\n      height: 20px;\n      padding: 0 10px;\n\n      p {\n        position: relative;\n        top: -5px;\n        color: #666;\n      }\n    }\n\n    .message-list {\n      height: 480px;\n      margin-bottom: 15px;\n      padding: 10px;\n      overflow: auto;\n\n      .time {\n        text-align: center;\n        font-size: 12px;\n        color: #666666;\n        margin-bottom: 10px;\n      }\n\n      .bubble-wrapper {\n        clear: right;\n        margin-bottom: 20px;\n        overflow: auto;\n\n        .bubble {\n          display: inline-block;\n          max-width: 65%;\n          padding: 9px 14px;\n          border-radius: 20px;\n          font-size: 14px;\n          line-height: 24px;\n        }\n\n        .left-bubble {\n          float: left;\n          background: #fdfdfd;\n          border: 1px solid rgba(0, 0, 0, 0.05);\n          border-top-left-radius: 0;\n        }\n\n        .right-bubble {\n          float: right;\n          color: #fff;\n          background-color: #3FD1E1;\n          border-bottom-right-radius: 0;\n        }\n      }\n    }\n\n    .message-input {\n      textarea {\n        resize: none;\n        height: 100%;\n      }\n    }\n  }\n}\n</style>\n"]}]}